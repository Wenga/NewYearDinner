<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>新春奶茶盲盒</title>
  <style>
    :root{
      --bg1:#4b0006;
      --bg2:#b10012;
      --gold1:#ffef9a;
      --gold2:#ffcc4d;
      --gold3:#b7791f;
      --ink:#120002;
      --paper:#fff7e6;

      /* 奶茶主题 */
      --milk:#fff2d9;
      --tea:#c8894a;
      --cupLine: rgba(255,245,200,.55);
      --straw:#ff6b6b;
      --brand:#f6d38a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Noto Sans SC",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--paper);
      min-height:100vh;
      background:
        radial-gradient(900px 900px at 50% -10%, rgba(255,210,120,.25), transparent 60%),
        radial-gradient(700px 700px at 10% 20%, rgba(255,180,180,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      display:flex;
      justify-content:center;
    }

    /* 手机竖屏容器 */
    .screen{
      width:min(430px, 100%);
      min-height:100vh;
      padding:18px 18px 22px;
      position:relative;
      overflow:hidden;

      background:
        radial-gradient(900px 900px at 50% -10%, rgba(255,210,120,.25), transparent 60%),
        radial-gradient(700px 700px at 10% 20%, rgba(255,180,180,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
    }

    /* 暗纹 */
    .pattern{
      position:absolute; inset:-40px;
      background:
        radial-gradient(18px 18px at 20% 25%, rgba(255,255,255,.05) 0 2px, transparent 3px),
        radial-gradient(18px 18px at 60% 45%, rgba(255,255,255,.04) 0 2px, transparent 3px),
        radial-gradient(18px 18px at 80% 70%, rgba(255,255,255,.03) 0 2px, transparent 3px);
      pointer-events:none;
      opacity:.9;
    }

    header{
      position:relative;
      padding-top:8px;
      text-align:center;
    }
    .kicker{
      letter-spacing:.22em;
      font-size:12px;
      opacity:.9;
      line-height:1.15;
    }
    h1{
      margin:10px 0 6px;
      font-size:20px;
      line-height:1.25;
      font-weight:700;
    }
    .sub{
      margin:0;
      font-size:13px;
      opacity:.85;
      line-height:1.35;
    }

    /* 双语副文本统一样式 */
    .en{
      display:block;
      margin-top:4px;
      font-size:.82em;
      opacity:.78;
      letter-spacing:.02em;
      font-weight:400;
    }

    /* 顶部灯笼（装饰） */
    .lanterns{
      position:absolute;
      top:-6px; left:0; right:0;
      display:flex;
      justify-content:space-between;
      padding:0 8px;
      pointer-events:none;
      opacity:.9;
    }
    .lantern{
      width:44px; height:62px;
      position:relative;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.35));
      animation:sway 2.6s ease-in-out infinite;
      transform-origin:50% 0%;
    }
    .lantern:nth-child(2){ animation-delay:.6s; opacity:.85; transform:scale(.95); }
    .lantern::before{
      content:"";
      position:absolute; inset:10px 6px 10px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.18), transparent 40%),
        radial-gradient(120px 80px at 30% 25%, rgba(255,220,140,.25), transparent 55%),
        linear-gradient(180deg, #e21a2b, #940012);
      border-radius:16px;
      border:1px solid rgba(255,220,140,.35);
    }
    .lantern::after{
      content:"";
      position:absolute; left:50%; top:0;
      width:2px; height:12px;
      background:rgba(255,220,140,.55);
      transform:translateX(-50%);
      border-radius:2px;
    }
    .tassel{
      position:absolute; left:50%; bottom:0;
      width:10px; height:18px;
      transform:translateX(-50%);
      background:linear-gradient(180deg, rgba(255,220,140,.65), rgba(255,220,140,.15));
      border-radius:0 0 10px 10px;
    }
    @keyframes sway{
      0%,100%{ transform:rotate(-2deg); }
      50%{ transform:rotate(2deg); }
    }

    main{
      margin-top:22px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      position:relative;
    }

    /* 盲盒结果饮品图显示在舞台中央 */
    .hatchedDrink{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -52%) scale(.92);
      width: 78%;
      height: auto;
      max-height: 85%;
      object-fit: contain;
      display:none;
      pointer-events:none;
      filter: drop-shadow(0 18px 35px rgba(0,0,0,.35));
    }
    .hatchedDrink.show{
      display:block;
      animation: drinkPop .42s ease-out forwards;
    }
    @keyframes drinkPop{
      0%   { transform: translate(-50%, -52%) scale(.72); opacity: 0; }
      100% { transform: translate(-50%, -52%) scale(1);   opacity: 1; }
    }

    /* 奶茶杯舞台 */
    .stage{
      width:min(320px, 86vw);
      aspect-ratio:1 / 1.15;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .glow{
      position:absolute;
      width: 160%;
      height: 130%;
      background:radial-gradient(closest-side, rgba(255,220,120,.7), transparent 68%);
      filter:blur(10px);
      opacity:1;
      pointer-events:none;
      animation:pulse 2.2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform:scale(1); opacity:.75; }
      50%{ transform:scale(1.04); opacity:1; }
    }

    button.eggBtn{
      all:unset;
      width:78%;
      height:78%;
      cursor:pointer;
      border-radius:26px;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    /* 奶茶杯本体 */
    .cup{
      width:100%;
      height:100%;
      position:relative;
      transform:translateZ(0);
      animation:float 3s ease-in-out infinite;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    @keyframes float{
      0%,100%{ transform:translateY(0px); }
      50%{ transform:translateY(-6px); }
    }

    .cupSvg{
      width:100%;
      height:100%;
      filter:
        drop-shadow(0 18px 40px rgba(0,0,0,.35));
    }

    /* “裂纹”改成：杯身涟漪/气泡层 */
    .cracks{
      position:absolute; inset:0;
      opacity:0;
      transition:opacity .25s ease;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .cracks.show1{ opacity:.35; }
    .cracks.show2{ opacity:.7; }

    /* 点击摇晃 */
    .shake{ animation:shake .28s ease-in-out; }
    @keyframes shake{
      0%{ transform:rotate(0deg); }
      25%{ transform:rotate(-2deg); }
      50%{ transform:rotate(2deg); }
      75%{ transform:rotate(-1deg); }
      100%{ transform:rotate(0deg); }
    }

    /* 金粉粒子（保留，可理解为“奶茶闪粉/香气粒子”） */
    .spark{
      position:absolute;
      width:6px; height:6px;
      border-radius:50%;
      background:rgba(255,230,150,.95);
      box-shadow:0 0 10px rgba(255,230,150,.75);
      pointer-events:none;
      animation:pop .7s ease-out forwards;
    }
    @keyframes pop{
      0%{ transform:translate(0,0) scale(1); opacity:1; }
      100%{ transform:translate(var(--dx), var(--dy)) scale(.2); opacity:0; }
    }

    .cta{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      text-align:center;
    }
    .hint{
      font-size:13px;
      opacity:.9;
      line-height:1.25;
    }
    .meter{
      font-size:12px;
      opacity:.75;
      line-height:1.25;
    }

    .result{
      width:min(360px, 92vw);
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,235,180,.25);
      border-radius:18px;
      padding:14px 14px 12px;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
      display:none;
      backdrop-filter:blur(6px);
    }
    .result.show{ display:block; }
    .result .row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .result h2{
      margin:0;
      font-size:16px;
      line-height:1.25;
    }
    .result p{
      margin:6px 0 0;
      font-size:13px;
      opacity:.9;
      line-height:1.4;
    }
    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      line-height:1.15;
    }
    .btn .en{ margin-top:3px; }
    .btn.primary{
      background:linear-gradient(180deg, rgba(255,235,180,.95), rgba(255,200,90,.92));
      color:var(--ink);
      border:1px solid rgba(255,245,200,.45);
    }
    .btn.ghost{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,235,180,.25);
      color:var(--paper);
    }

    /* 截图模式：冻结动画 & 强制最终布局 */
    .screenshot-mode .lantern,
    .screenshot-mode .glow,
    .screenshot-mode .cup,
    .screenshot-mode .hatchedDrink{
      animation: none !important;
    }

    /* 截图模式下的布局修复 */
    .screenshot-mode .stage {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .screenshot-mode .hatchedDrink {
      position: relative !important;
      left: auto !important;
      top: auto !important;
      transform: scale(1.1) !important;
      display: block !important;
      opacity: 1 !important;
      margin: 0 auto !important;
    }

  </style>
</head>

<body>
  <div class="screen" id="captureRoot">
    <div class="pattern"></div>

    <div class="lanterns" aria-hidden="true">
      <div class="lantern"><div class="tassel"></div></div>
      <div class="lantern"><div class="tassel"></div></div>
    </div>

    <header>
      <div class="kicker">
        新春好运
        <span class="en">New Year Blessings</span>
      </div>

      <h1>
        新春奶茶盲盒
        <span class="en">New Year Milk Tea Blind Box</span>
      </h1>

      <p class="sub">
        每一次点击都会留下香气粒子与波纹
        <span class="en">Every tap leaves a trace of sparkles and ripples</span>
      </p>
    </header>

    <main>
      <div class="stage">
        <div class="glow"></div>

        <button class="eggBtn" id="eggBtn" aria-label="点击奶茶杯开盲盒 / Tap to reveal">
          <div class="cup" id="cup">
            <!-- 奶茶杯 SVG（替代金蛋） -->
            <svg class="cupSvg" viewBox="0 0 200 240" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <defs>
                <linearGradient id="cupBody" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0" stop-color="rgba(255,255,255,.22)"/>
                  <stop offset=".55" stop-color="rgba(255,255,255,.08)"/>
                  <stop offset="1" stop-color="rgba(0,0,0,.10)"/>
                </linearGradient>

                <linearGradient id="teaFill" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0" stop-color="rgba(255,242,217,.95)"/>
                  <stop offset=".5" stop-color="rgba(200,137,74,.95)"/>
                  <stop offset="1" stop-color="rgba(160,90,40,.95)"/>
                </linearGradient>

                <radialGradient id="shine" cx="35%" cy="22%" r="65%">
                  <stop offset="0" stop-color="rgba(255,255,255,.55)"/>
                  <stop offset="1" stop-color="rgba(255,255,255,0)"/>
                </radialGradient>
              </defs>

              <!-- straw -->
              <path d="M122 16 C135 35, 125 55, 140 72"
                    fill="none" stroke="rgba(255,107,107,.9)" stroke-width="10" stroke-linecap="round"/>
              <path d="M122 16 C135 35, 125 55, 140 72"
                    fill="none" stroke="rgba(255,255,255,.25)" stroke-width="3" stroke-linecap="round"/>

              <!-- lid -->
              <path d="M44 70 C70 50, 130 50, 156 70"
                    fill="rgba(30,0,5,.28)" stroke="rgba(255,245,200,.45)" stroke-width="2.5" />
              <path d="M40 74 C68 56, 132 56, 160 74"
                    fill="rgba(255,255,255,.08)" stroke="rgba(255,245,200,.35)" stroke-width="2" />

              <!-- cup outline -->
              <path d="M52 80 L68 210 C70 224, 82 234, 96 234 H104 C118 234, 130 224, 132 210 L148 80 Z"
                    fill="url(#cupBody)" stroke="rgba(255,245,200,.55)" stroke-width="2.5" />

              <!-- tea fill -->
              <path d="M60 112 L72 206 C73 214, 80 220, 88 220 H112 C120 220, 127 214, 128 206 L140 112 Z"
                    fill="url(#teaFill)" opacity=".96"/>

              <!-- brand logo image -->
              <image
                href="mollytealogo.png"
                x="78"
                y="138"
                width="44"
                height="44"
                opacity="0.9"
              />

            </svg>

            <!-- 原 cracks 层继续复用：改成波纹/气泡线条 -->
            <svg class="cracks" id="cracks" viewBox="0 0 200 240" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M70 128 C90 120, 110 120, 130 128"
                    stroke="rgba(255,245,200,.55)" stroke-width="3" stroke-linecap="round"/>
              <path d="M66 150 C90 142, 110 142, 134 150"
                    stroke="rgba(255,245,200,.42)" stroke-width="2.6" stroke-linecap="round"/>
              <path d="M72 172 C92 165, 108 165, 128 172"
                    stroke="rgba(255,245,200,.35)" stroke-width="2.6" stroke-linecap="round"/>
            </svg>

          </div>
        </button>

        <img id="hatchedDrink" class="hatchedDrink" alt="" />
      </div>

      <div class="cta">
        <div class="hint" id="hint">
          点击奶茶杯开盲盒
          <span class="en">Tap the milk tea cup to begin</span>
        </div>
        <div class="meter" id="meter">
          进度：0 / 3
          <span class="en">Progress: 0 / 3</span>
        </div>
      </div>

      <section class="result" id="result" aria-live="polite">
        <div class="row">
          <div>
            <h2 id="drinkTitle">
              你抽到了：
              <span class="en">You got:</span>
            </h2>
            <p id="drinkLine">
              描述会显示在这里
              <span class="en">Your description will appear here</span>
            </p>
          </div>
        </div>

        <div class="actions">
          <div class="btn primary" id="resetBtn">
            再抽一次
            <span class="en">Draw again</span>
          </div>
          <div class="btn ghost" id="shareBtn">
            截图保存页面
            <span class="en">Save screenshot</span>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    (function(){

      function isIOSDevice() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent);
      }

      async function canvasToBlobSafe(canvas) {
        const blob = await new Promise((resolve) => {
          if (!canvas.toBlob) return resolve(null);
          canvas.toBlob((b) => resolve(b), 'image/png', 1);
        });
        if (blob) return blob;

        const dataUrl = canvas.toDataURL('image/png', 1);
        const res = await fetch(dataUrl);
        return await res.blob();
      }

      const eggBtn = document.getElementById('eggBtn');
      const cup = document.getElementById('cup');
      const cracks = document.getElementById('cracks');
      const hint = document.getElementById('hint');
      const meter = document.getElementById('meter');
      const result = document.getElementById('result');
      const hatchedDrink = document.getElementById('hatchedDrink');
      const drinkTitle = document.getElementById('drinkTitle');
      const drinkLine = document.getElementById('drinkLine');
      const resetBtn = document.getElementById('resetBtn');
      const shareBtn = document.getElementById('shareBtn');

      const HATCH_AT = 3;
      let taps = 0;
      let hatched = false;

      // 双语提示语
      const hints = {
        start: { zh:"点击奶茶杯开盲盒", en:"Tap the milk tea cup to begin" },
        keep:  { zh:"继续点击，香气要出来了", en:"Keep tapping—aroma is coming" },
        mid:   { zh:"快要揭晓新品了", en:"Almost revealed" },
        done:  { zh:"揭晓完成", en:"Reveal complete" }
      };

      /**
       * 3 个奶茶（把 image 换成你真实的素材文件名即可）
       * 推荐放到同目录：Drink_A.png / Drink_B.png / Drink_C.png
       */
      const drinks = [
        {
          zhName: "山茶花乌龙",
          enName: "Camellia Oolong Milk Tea",
          image: "camellia_oolong.png",
          zhLine: "山茶初放，福运正浓。",
          enLine: "As camellias bloom, fortune flourishes."
        },
        {
          zhName: "橙意山茶",
          enName: "Camellia Zest",
          image: "camellia_zest.png",
          zhLine: "橙意满满，山茶呈祥。",
          enLine: "Overflowing with sincerity, camellias bring good fortune."
        },
        {
          zhName: "雪融抹茶山茶花",
          enName: "Camellia Matcha",
          image: "matcha.png",
          zhLine: "雪融见春，花开如愿。",
          enLine: "Snow melts, spring arrives; flowers bloom, wishes fulfilled."
        }
      ];

      function setHint(key){
        hint.innerHTML = `${hints[key].zh}<span class="en">${hints[key].en}</span>`;
      }

      function setProgress(){
        const t = Math.min(taps, HATCH_AT);
        meter.innerHTML = `进度：${t} / ${HATCH_AT}<span class="en">Progress: ${t} / ${HATCH_AT}</span>`;
      }

      function updateCracks(){
        cracks.classList.remove('show1','show2');
        if (!hatched){
          if (taps >= 2) cracks.classList.add('show2');
          else if (taps >= 1) cracks.classList.add('show1');
        }
      }

      function spawnSpark(x, y){
        const s = document.createElement('div');
        s.className = 'spark';
        const dx = (Math.random()*2-1) * 60;
        const dy = (Math.random()*2-1) * 70 - 20;
        s.style.setProperty('--dx', `${dx}px`);
        s.style.setProperty('--dy', `${dy}px`);
        s.style.left = `${x}px`;
        s.style.top  = `${y}px`;
        eggBtn.appendChild(s);
        setTimeout(()=> s.remove(), 800);
      }

      function hatch(){
        hatched = true;
        setHint('done');
        cracks.style.opacity = 0;

        const pick = drinks[Math.floor(Math.random()*drinks.length)];

        // 显示舞台中央饮品图
        hatchedDrink.src = pick.image;
        hatchedDrink.alt = `${pick.zhName} / ${pick.enName}`;
        hatchedDrink.classList.remove('show');
        void hatchedDrink.offsetWidth; // 触发动效重播
        hatchedDrink.classList.add('show');

        drinkTitle.innerHTML =
          `你抽到了：${pick.zhName}<span class="en">You got: ${pick.enName}</span>`;

        drinkLine.innerHTML =
          `${pick.zhLine}<span class="en">${pick.enLine}</span>`;

        cup.style.transition = "transform .35s ease, opacity .35s ease";
        cup.style.opacity = 0;
        cup.style.transform = "scale(.92)";
        result.classList.add('show');
      }

      function reset(){
        taps = 0;
        hatched = false;
        hatchedDrink.classList.remove('show');
        hatchedDrink.removeAttribute('src');
        hatchedDrink.alt = "";
        cup.style.transition = "";
        cup.style.opacity = 1;
        cup.style.transform = "";
        cracks.style.opacity = "";
        result.classList.remove('show');
        setHint('start');
        setProgress();
        updateCracks();
      }

      eggBtn.addEventListener('click', (e)=>{
        if (hatched) return;

        taps += 1;
        setProgress();
        updateCracks();

        cup.classList.remove('shake');
        void cup.offsetWidth;
        cup.classList.add('shake');

        const rect = eggBtn.getBoundingClientRect();
        spawnSpark(e.clientX - rect.left, e.clientY - rect.top);

        if (taps === 1) setHint('keep');
        if (taps === 2) setHint('mid');

        if (taps >= HATCH_AT) hatch();
      });

      // 防止移动端双击缩放（主要针对 iOS Safari）
      let lastTap = 0;
      eggBtn.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTap < 300) {
          e.preventDefault();
        }
        lastTap = now;
      }, { passive: false });

      resetBtn.addEventListener('click', reset);
      const captureRoot = document.getElementById('captureRoot');
      const stage = document.querySelector('.stage');

      shareBtn.addEventListener('click', async () => {

        const oldHTML = shareBtn.innerHTML;
        shareBtn.innerHTML = `正在生成图片…<span class="en">Rendering…</span>`;
        shareBtn.style.pointerEvents = 'none';

        try {
          document.body.classList.add('screenshot-mode');

          const prevStageHeight = stage.style.height;
          const prevStageAspect = stage.style.aspectRatio;

          const stageW = stage.getBoundingClientRect().width;
          stage.style.height = `${Math.round(stageW * 1.15)}px`;
          stage.style.aspectRatio = 'auto';

          await new Promise(r => requestAnimationFrame(r));

          if (hatchedDrink && hatchedDrink.src) {
            try { await hatchedDrink.decode(); } catch(e) {}
          }

          const clone = captureRoot.cloneNode(true);

          const clonedDrink = clone.querySelector('#hatchedDrink');
          if (clonedDrink && hatchedDrink && hatchedDrink.src) {
            clonedDrink.src = hatchedDrink.src;
            clonedDrink.style.position = 'relative';
            clonedDrink.style.transform = 'none';
            clonedDrink.style.display = 'block';
            clonedDrink.style.opacity = '1';
            clonedDrink.style.width = '100%';
          }

          const clonedStage = clone.querySelector('.stage');
          if (clonedStage) {
            clonedStage.style.display = 'flex';
            clonedStage.style.alignItems = 'center';
            clonedStage.style.justifyContent = 'center';
          }

          const cloneActions = clone.querySelector('.actions');
          if (cloneActions) cloneActions.style.visibility = 'hidden';

          const sandbox = document.createElement('div');
          sandbox.style.position = 'fixed';
          sandbox.style.left = '0';
          sandbox.style.top = '0';
          sandbox.style.width = '430px';
          sandbox.style.zIndex = '-1';
          sandbox.style.pointerEvents = 'none';
          sandbox.style.opacity = '0';
          sandbox.appendChild(clone);
          document.body.appendChild(sandbox);

          await new Promise(r => requestAnimationFrame(r));

          const scale = isIOSDevice() ? 1.5 : 2;

          const canvas = await html2canvas(clone, {
            backgroundColor: null,
            scale,
            useCORS: true,
            scrollX: 0,
            scrollY: 0,
            windowWidth: document.documentElement.clientWidth,
            windowHeight: document.documentElement.clientHeight
          });

          document.body.removeChild(sandbox);
          stage.style.height = prevStageHeight;
          stage.style.aspectRatio = prevStageAspect;

          const blob = await canvasToBlobSafe(canvas);
          if (!blob) throw new Error('blob failed');

          const fileName = `MilkTeaBlindBox_${Date.now()}.png`;
          const file = new File([blob], fileName, { type: 'image/png' });

          const canShareFile =
            navigator.canShare &&
            navigator.canShare({ files: [file] }) &&
            navigator.share;

          if (canShareFile) {
            try {
              await navigator.share({
                files: [file],
                title: '新春奶茶盲盒',
                text: '保存这张盲盒结果到相册吧'
              });
              shareBtn.innerHTML = `已打开分享<span class="en">Shared</span>`;
              setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 1400);
              return;
            } catch (e) {
              console.warn('navigator.share failed, fallback:', e);
            }
          }

          const url = URL.createObjectURL(blob);

          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if (isIOS) {
            window.open(url, '_blank');
            shareBtn.innerHTML = `已打开图片，请长按保存<span class="en">Open & long-press to save</span>`;
            setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 2200);
            setTimeout(() => URL.revokeObjectURL(url), 10000);
            return;
          }

          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          shareBtn.innerHTML = `已下载图片<span class="en">Downloaded</span>`;
          setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 1400);

        } catch (err) {
          console.error(err);
          shareBtn.innerHTML = `生成失败，请重试<span class="en">Failed</span>`;
          setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 1600);
        } finally {
          document.body.classList.remove('screenshot-mode');
          shareBtn.style.pointerEvents = '';
        }
      });

      // init
      setHint('start');
      setProgress();
      updateCracks();
    })();
  </script>
</body>
</html>
