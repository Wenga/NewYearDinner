<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>新春金蛋孵化 | New Year Golden Egg</title>
  <style>
    :root{
      --bg1:#4b0006;
      --bg2:#b10012;
      --gold1:#ffef9a;
      --gold2:#ffcc4d;
      --gold3:#b7791f;
      --ink:#120002;
      --paper:#fff7e6;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Noto Sans SC",Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--paper);
      min-height:100vh;
      background:
        radial-gradient(900px 900px at 50% -10%, rgba(255,210,120,.25), transparent 60%),
        radial-gradient(700px 700px at 10% 20%, rgba(255,180,180,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      display:flex;
      justify-content:center;
    }

    /* 手机竖屏容器 */
    .screen{
      width:min(430px, 100%);
      min-height:100vh;
      padding:18px 18px 22px;
      position:relative;
      overflow:hidden;

      /* 关键：给截图根节点也加背景*/
      background:
        radial-gradient(900px 900px at 50% -10%, rgba(255,210,120,.25), transparent 60%),
        radial-gradient(700px 700px at 10% 20%, rgba(255,180,180,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
    }

    /* 暗纹 */
    .pattern{
      position:absolute; inset:-40px;
      background:
        radial-gradient(18px 18px at 20% 25%, rgba(255,255,255,.05) 0 2px, transparent 3px),
        radial-gradient(18px 18px at 60% 45%, rgba(255,255,255,.04) 0 2px, transparent 3px),
        radial-gradient(18px 18px at 80% 70%, rgba(255,255,255,.03) 0 2px, transparent 3px);
      pointer-events:none;
      opacity:.9;
    }

    header{
      position:relative;
      padding-top:8px;
      text-align:center;
    }
    .kicker{
      letter-spacing:.22em;
      font-size:12px;
      opacity:.9;
      line-height:1.15;
    }
    h1{
      margin:10px 0 6px;
      font-size:20px;
      line-height:1.25;
      font-weight:700;
    }
    .sub{
      margin:0;
      font-size:13px;
      opacity:.85;
      line-height:1.35;
    }

    /* 双语副文本统一样式 */
    .en{
      display:block;
      margin-top:4px;
      font-size:.82em;
      opacity:.78;
      letter-spacing:.02em;
      font-weight:400;
    }

    /* 顶部灯笼（装饰） */
    .lanterns{
      position:absolute;
      top:-6px; left:0; right:0;
      display:flex;
      justify-content:space-between;
      padding:0 8px;
      pointer-events:none;
      opacity:.9;
    }
    .lantern{
      width:44px; height:62px;
      position:relative;
      filter:drop-shadow(0 10px 18px rgba(0,0,0,.35));
      animation:sway 2.6s ease-in-out infinite;
      transform-origin:50% 0%;
    }
    .lantern:nth-child(2){ animation-delay:.6s; opacity:.85; transform:scale(.95); }
    .lantern::before{
      content:"";
      position:absolute; inset:10px 6px 10px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.18), transparent 40%),
        radial-gradient(120px 80px at 30% 25%, rgba(255,220,140,.25), transparent 55%),
        linear-gradient(180deg, #e21a2b, #940012);
      border-radius:16px;
      border:1px solid rgba(255,220,140,.35);
    }
    .lantern::after{
      content:"";
      position:absolute; left:50%; top:0;
      width:2px; height:12px;
      background:rgba(255,220,140,.55);
      transform:translateX(-50%);
      border-radius:2px;
    }
    .tassel{
      position:absolute; left:50%; bottom:0;
      width:10px; height:18px;
      transform:translateX(-50%);
      background:linear-gradient(180deg, rgba(255,220,140,.65), rgba(255,220,140,.15));
      border-radius:0 0 10px 10px;
    }
    @keyframes sway{
      0%,100%{ transform:rotate(-2deg); }
      50%{ transform:rotate(2deg); }
    }

    main{
      margin-top:22px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      position:relative;
    }

    /* 孵化结果马图显示在舞台中央 */
    .hatchedHorse{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -52%) scale(.92);
      width: 78%;
      height: auto;
      max-height: 85%;
      object-fit: contain;
      display:none;              /* 默认隐藏 */
      pointer-events:none;
      filter: drop-shadow(0 18px 35px rgba(0,0,0,.35));
    }

    .hatchedHorse.show{
      display:block;
      animation: horsePop .42s ease-out forwards;
    }

    @keyframes horsePop{
      0%   { transform: translate(-50%, -52%) scale(.72); opacity: 0; }
      100% { transform: translate(-50%, -52%) scale(1);   opacity: 1; }
    }

    /* 金蛋舞台 */
    .stage{
      width:min(320px, 86vw);
      aspect-ratio:1 / 1.15;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
    }
    .glow{
      position:absolute;
      width: 160%;
      height: 130%;
      background:radial-gradient(closest-side, rgba(255,220,120,.7), transparent 68%);
      filter:blur(10px);
      opacity:1;
      pointer-events:none;
      animation:pulse 2.2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform:scale(1); opacity:.75; }
      50%{ transform:scale(1.04); opacity:1; }
    }

    button.eggBtn{
      all:unset;
      width:78%;
      height:78%;
      cursor:pointer;
      border-radius:999px;
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    /* 金蛋本体 */
    .egg{
      width:100%;
      height:100%;
      border-radius:50% 50% 45% 45%;
      background:
        radial-gradient(120px 160px at 35% 22%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(260px 260px at 60% 70%, rgba(0,0,0,.22), transparent 55%),
        linear-gradient(180deg, var(--gold1), var(--gold2) 42%, var(--gold3));
      border:1px solid rgba(255,240,180,.55);
      box-shadow:
        0 18px 40px rgba(0,0,0,.35),
        inset 0 8px 14px rgba(255,255,255,.18),
        inset 0 -10px 18px rgba(0,0,0,.25);
      position:relative;
      transform:translateZ(0);
      animation:float 3s ease-in-out infinite;
    }
    @keyframes float{
      0%,100%{ transform:translateY(0px); }
      50%{ transform:translateY(-6px); }
    }

    /* 裂纹层 */
    .cracks{
      position:absolute; inset:0;
      opacity:0;
      transition:opacity .25s ease;
      pointer-events:none;
      mix-blend-mode:multiply;
    }
    .cracks.show1{ opacity:.35; }
    .cracks.show2{ opacity:.7; }

    /* 点击摇晃 */
    .shake{ animation:shake .28s ease-in-out; }
    @keyframes shake{
      0%{ transform:rotate(0deg); }
      25%{ transform:rotate(-2deg); }
      50%{ transform:rotate(2deg); }
      75%{ transform:rotate(-1deg); }
      100%{ transform:rotate(0deg); }
    }

    /* 金粉粒子 */
    .spark{
      position:absolute;
      width:6px; height:6px;
      border-radius:50%;
      background:rgba(255,230,150,.95);
      box-shadow:0 0 10px rgba(255,230,150,.75);
      pointer-events:none;
      animation:pop .7s ease-out forwards;
    }
    @keyframes pop{
      0%{ transform:translate(0,0) scale(1); opacity:1; }
      100%{ transform:translate(var(--dx), var(--dy)) scale(.2); opacity:0; }
    }

    .cta{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:8px;
      text-align:center;
    }
    .hint{
      font-size:13px;
      opacity:.9;
      line-height:1.25;
    }
    .meter{
      font-size:12px;
      opacity:.75;
      line-height:1.25;
    }

    .result{
      width:min(360px, 92vw);
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,235,180,.25);
      border-radius:18px;
      padding:14px 14px 12px;
      box-shadow:0 14px 30px rgba(0,0,0,.25);
      display:none;
      backdrop-filter:blur(6px);
    }
    .result.show{ display:block; }
    .result .row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .result h2{
      margin:0;
      font-size:16px;
      line-height:1.25;
    }
    .result p{
      margin:6px 0 0;
      font-size:13px;
      opacity:.9;
      line-height:1.4;
    }
    .actions{
      margin-top:10px;
      display:flex;
      gap:10px;
    }
    .btn{
      flex:1;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      line-height:1.15;
    }
    .btn .en{ margin-top:3px; }
    .btn.primary{
      background:linear-gradient(180deg, rgba(255,235,180,.95), rgba(255,200,90,.92));
      color:var(--ink);
      border:1px solid rgba(255,245,200,.45);
    }
    .btn.ghost{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,235,180,.25);
      color:var(--paper);
    }
    /* 截图模式：冻结动画 & 强制最终布局 */
    .screenshot-mode .lantern,
    .screenshot-mode .glow,
    .screenshot-mode .egg,
    .screenshot-mode .hatchedHorse{
      animation: none !important;
    }

    /* 截图模式下的布局修复 */
    .screenshot-mode .stage {
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .screenshot-mode .hatchedHorse {
      position: relative !important; /* 取消绝对定位 */
      left: auto !important;
      top: auto !important;
      transform: scale(1.1) !important; /* 调整大小，补偿原本 translate 的偏移感 */
      display: block !important;
      opacity: 1 !important;
      margin: 0 auto !important;
    }

  </style>
</head>

<body>
  <div class="screen" id="captureRoot">
    <div class="pattern"></div>

    <div class="lanterns" aria-hidden="true">
      <div class="lantern"><div class="tassel"></div></div>
      <div class="lantern"><div class="tassel"></div></div>
    </div>

    <header>
      <div class="kicker">
        新春好运
        <span class="en">New Year Blessings</span>
      </div>

      <h1>
        点击金蛋，孵化你的新年灵兽
        <span class="en">Tap the golden egg to hatch your New Year spirit animal</span>
      </h1>

      <p class="sub">
        每一次点击都会留下金粉与裂纹
        <span class="en">Every tap leaves a trace of golden sparkles and cracks</span>
      </p>
    </header>

    <main>
      <div class="stage">
        <div class="glow"></div>

        <button class="eggBtn" id="eggBtn" aria-label="点击金蛋孵化 / Tap to hatch">
          <div class="egg" id="egg">
            <svg class="cracks" id="cracks" viewBox="0 0 200 240" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M110 35 C90 65, 120 85, 98 115 C82 138, 110 150, 95 178 C82 201, 105 215, 100 232"
                    stroke="rgba(120,70,10,.85)" stroke-width="3" stroke-linecap="round"/>
              <path d="M78 70 C92 88, 68 104, 86 125 C102 144, 78 156, 90 176"
                    stroke="rgba(120,70,10,.75)" stroke-width="2.6" stroke-linecap="round"/>
              <path d="M132 78 C120 98, 146 110, 126 132 C110 150, 138 162, 120 188"
                    stroke="rgba(120,70,10,.75)" stroke-width="2.6" stroke-linecap="round"/>
            </svg>
          </div>
        </button>
        <img id="hatchedHorse" class="hatchedHorse" alt="" />
      </div>

      <div class="cta">
        <div class="hint" id="hint">
          点击金蛋开始孵化
          <span class="en">Tap the golden egg to begin</span>
        </div>
        <div class="meter" id="meter">
          进度：0 / 6
          <span class="en">Progress: 0 / 6</span>
        </div>
      </div>

      <section class="result" id="result" aria-live="polite">
        <div class="row">

          <div>
            <h2 id="animalTitle">
              你成功孵化出：
              <span class="en">You successfully hatched:</span>
            </h2>
            <p id="animalLine">
              祝福语会显示在这里
              <span class="en">Your blessing will appear here</span>
            </p>
          </div>
        </div>

        <div class="actions">
          <div class="btn primary" id="resetBtn">
            再孵一次
            <span class="en">Hatch again</span>
          </div>
          <div class="btn ghost" id="shareBtn">
            截图保存页面
            <span class="en">Save screenshot</span>
          </div>
        </div>
      </section>

    </main>


  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <script>
    (function(){

      function isIOSDevice() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent);
      }

      async function canvasToBlobSafe(canvas) {
        const blob = await new Promise((resolve) => {
          if (!canvas.toBlob) return resolve(null);
          canvas.toBlob((b) => resolve(b), 'image/png', 1);
        });
        if (blob) return blob;

        const dataUrl = canvas.toDataURL('image/png', 1);
        const res = await fetch(dataUrl);
        return await res.blob();
      }

      const eggBtn = document.getElementById('eggBtn');
      const egg = document.getElementById('egg');
      const cracks = document.getElementById('cracks');
      const hint = document.getElementById('hint');
      const meter = document.getElementById('meter');
      const result = document.getElementById('result');
      const hatchedHorse = document.getElementById('hatchedHorse');
      const animalTitle = document.getElementById('animalTitle');
      const animalLine = document.getElementById('animalLine');
      const resetBtn = document.getElementById('resetBtn');
      const shareBtn = document.getElementById('shareBtn');

      const HATCH_AT = 6;
      let taps = 0;
      let hatched = false;

      // 双语提示语
      const hints = {
        start: { zh:"点击金蛋开始孵化", en:"Tap the golden egg to begin" },
        keep:  { zh:"继续点击，会出现裂纹", en:"Keep tapping to reveal cracks" },
        mid:   { zh:"裂纹出现了，再点几下", en:"Cracks appear, keep going" },
        near:  { zh:"快要孵化了", en:"Almost there" },
        done:  { zh:"孵化完成", en:"Hatching complete" }
      };

      // 自定义灵兽”
      const animals = [
        { zhName:"福运灵马", enName:"Lucky Spirit Horse", 
          image: "LuckyHorse.png",
          zhLine:"福气相随，好运常在。", enLine:"Blessings follow, good fortune stays." },
        { zhName:"金财瑞马", enName:"Golden Wealth Horse", 
          image: "WealthHorse.png",
          zhLine:"财运丰盈，收获满满。", enLine:"Prosperity flows, abundance grows." },
        { zhName:"瑞玉守马", enName:"Jade Guardian Horse", 
          image: "JadeHorse.png",
          zhLine:"平安守护，家和人安。", enLine:"Peace protected, harmony within." },
        { zhName:"祥云风马", enName:"Auspicious Cloud Horse", 
          image: "CloudHorse.png",        
          zhLine:"祥云相伴，万事顺遂。", enLine:"Auspicious signs guide your way." },
        { zhName:"喜庆灯马", enName:"Joyful Lantern Horse", 
          image: "LanternHorse.png",
          zhLine:"灯火团圆，欢喜满堂。", enLine:"Joy lights up every gathering." },
        { zhName:"吉星夜马", enName:"Fortune Star Horse", 
          image: "StarHorse.png",
          zhLine:"吉星高照，心愿可期。", enLine:"Lucky stars, wishes await." },
      ];

      function setHint(key){
        hint.innerHTML = `${hints[key].zh}<span class="en">${hints[key].en}</span>`;
      }

      function setProgress(){
        const t = Math.min(taps, HATCH_AT);
        meter.innerHTML = `进度：${t} / ${HATCH_AT}<span class="en">Progress: ${t} / ${HATCH_AT}</span>`;
      }

      function updateCracks(){
        cracks.classList.remove('show1','show2');
        if (!hatched){
          if (taps >= 5) cracks.classList.add('show2');
          else if (taps >= 3) cracks.classList.add('show1');
        }
      }

      function spawnSpark(x, y){
        const s = document.createElement('div');
        s.className = 'spark';
        const dx = (Math.random()*2-1) * 60;
        const dy = (Math.random()*2-1) * 70 - 20;
        s.style.setProperty('--dx', `${dx}px`);
        s.style.setProperty('--dy', `${dy}px`);
        s.style.left = `${x}px`;
        s.style.top  = `${y}px`;
        eggBtn.appendChild(s);
        setTimeout(()=> s.remove(), 800);
      }

      function hatch(){
        hatched = true;
        setHint('done');
        cracks.style.opacity = 0;

        const pick = animals[Math.floor(Math.random()*animals.length)];

        //显示舞台中央马图
        hatchedHorse.src = pick.image;
        hatchedHorse.alt = `${pick.zhName} / ${pick.enName}`;
        hatchedHorse.classList.remove('show');
        void hatchedHorse.offsetWidth; // 触发动效重播
        hatchedHorse.classList.add('show');

        animalTitle.innerHTML =
          `你成功孵化出：${pick.zhName}<span class="en">You successfully hatched: ${pick.enName}</span>`;

        animalLine.innerHTML =
          `${pick.zhLine}<span class="en">${pick.enLine}</span>`;

        egg.style.transition = "transform .35s ease, opacity .35s ease";
        egg.style.opacity = 0;
        egg.style.transform = "scale(.92)";
        result.classList.add('show');
      }

      function reset(){
        taps = 0;
        hatched = false;
        hatchedHorse.classList.remove('show');
        hatchedHorse.removeAttribute('src');
        hatchedHorse.alt = "";
        egg.style.transition = "";
        egg.style.opacity = 1;
        egg.style.transform = "";
        cracks.style.opacity = "";
        result.classList.remove('show');
        setHint('start');
        setProgress();
        updateCracks();
      }

      eggBtn.addEventListener('click', (e)=>{
        if (hatched) return;

        taps += 1;
        setProgress();
        updateCracks();

        egg.classList.remove('shake');
        void egg.offsetWidth;
        egg.classList.add('shake');

        const rect = eggBtn.getBoundingClientRect();
        spawnSpark(e.clientX - rect.left, e.clientY - rect.top);

        if (taps === 1) setHint('keep');
        if (taps === 3) setHint('mid');
        if (taps === 5) setHint('near');

        if (taps >= HATCH_AT) hatch();
      });

      //防止移动端双击缩放（主要针对 iOS Safari）
      let lastTap = 0;
      eggBtn.addEventListener('touchend', (e) => {
        const now = Date.now();
        if (now - lastTap < 300) {
          e.preventDefault(); // 阻止 double-tap zoom
        }
        lastTap = now;
      }, { passive: false });

      resetBtn.addEventListener('click', reset);
      const captureRoot = document.getElementById('captureRoot');
      const stage = document.querySelector('.stage');

      shareBtn.addEventListener('click', async () => {
        // 还没孵化就截图：你可以允许，也可以提示先孵化
        // if (!hatched) return;

        const oldHTML = shareBtn.innerHTML;
        shareBtn.innerHTML = `正在生成图片…<span class="en">Rendering…</span>`;
        shareBtn.style.pointerEvents = 'none';

        try {
          // 进入截图模式（冻结动画）
          document.body.classList.add('screenshot-mode');
          // 截图前：固化 stage 的高度，避免 html2canvas 不支持 aspect-ratio 导致定位错乱
          const prevStageHeight = stage.style.height;
          const prevStageAspect = stage.style.aspectRatio;

          const stageW = stage.getBoundingClientRect().width;
          // 你的 aspect-ratio 是 1 / 1.15，所以高度 = 宽度 * 1.15
          stage.style.height = `${Math.round(stageW * 1.15)}px`;
          stage.style.aspectRatio = 'auto';

          // 等一帧让布局生效
          await new Promise(r => requestAnimationFrame(r));

          // 等神兽图片 decode 完成（防止资源未就绪）
          if (hatchedHorse && hatchedHorse.src) {
            try { await hatchedHorse.decode(); } catch(e) {}
          }

          // 1) 克隆截图根节点，放到一个“干净的固定定位舞台”里
          const clone = captureRoot.cloneNode(true);

          // 让 clone 里的神兽也保持显示（因为克隆时 class/inline 都会带上，但保险起见）
          const clonedHorse = clone.querySelector('#hatchedHorse');
          if (clonedHorse && hatchedHorse && hatchedHorse.src) {
            clonedHorse.src = hatchedHorse.src;
            // 强制移除可能干扰 html2canvas 的 transform
            clonedHorse.style.position = 'relative';
            clonedHorse.style.left = '0';
            clonedHorse.style.top = '0';
            clonedHorse.style.transform = 'none'; 
            clonedHorse.style.display = 'block';
            clonedHorse.style.opacity = '1';
        }

        // 确保父容器 stage 在克隆体中也是 Flex
        const clonedStage = clone.querySelector('.stage');
        if (clonedStage) {
            clonedStage.style.display = 'flex';
            clonedStage.style.alignItems = 'center';
            clonedStage.style.justifyContent = 'center';
        }

          // 2) 截图时隐藏 clone 内的按钮区（不影响原页面布局）
          const cloneActions = clone.querySelector('.actions');
          if (cloneActions) cloneActions.style.visibility = 'hidden';

          // 3) 创建一个离屏容器承载 clone（关键：固定在 0,0，避免任何居中/滚动干扰）
          const sandbox = document.createElement('div');
          sandbox.style.position = 'fixed';
          sandbox.style.left = '0';
          sandbox.style.top = '0';
          sandbox.style.width = '430px';         // 与你 .screen 的最大宽一致
          sandbox.style.zIndex = '-1';           // 不挡交互
          sandbox.style.pointerEvents = 'none';
          sandbox.style.opacity = '0';           // 不可见，但仍可渲染
          sandbox.appendChild(clone);
          document.body.appendChild(sandbox);

          // 等待一帧，确保 clone 完整布局
          await new Promise(r => requestAnimationFrame(r));

          // 4) 对 clone 截图
          const scale = isIOSDevice() ? 1.5 : 2;

          const canvas = await html2canvas(clone, {
            backgroundColor: null,
            scale,
            useCORS: true,
            scrollX: 0,
            scrollY: 0,
            windowWidth: document.documentElement.clientWidth,
            windowHeight: document.documentElement.clientHeight
          });

          // 5) 清理 sandbox
          document.body.removeChild(sandbox);
          // 截图后：还原 stage 样式
          stage.style.height = prevStageHeight;
          stage.style.aspectRatio = prevStageAspect;

          const blob = await canvasToBlobSafe(canvas);
          if (!blob) throw new Error('blob failed');

          const fileName = `NewYearHorse_${Date.now()}.png`;
          const file = new File([blob], fileName, { type: 'image/png' });

          // 优先：系统分享（iOS/Android 支持时可直接“存储到照片/相册”）
          const canShareFile =
            navigator.canShare &&
            navigator.canShare({ files: [file] }) &&
            navigator.share;

          // if (canShareFile) {
          //   await navigator.share({
          //     files: [file],
          //     title: '新春灵兽',
          //     text: '保存这张新春截图到相册吧'
          //   });
          //   shareBtn.innerHTML = `已打开分享<span class="en">Shared</span>`;
          //   setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 1400);
          //   return;
          // }

          if (canShareFile) {
            try {
              await navigator.share({
                files: [file],
                title: '新春灵兽',
                text: '保存这张新春截图到相册吧'
              });
              shareBtn.innerHTML = `已打开分享<span class="en">Shared</span>`;
              setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 1400);
              return;
            } catch (e) {
              console.warn('navigator.share failed, fallback to download/open:', e);
              // 不要 throw！继续走后面的 url + 下载/打开逻辑
            }
          }


          // 备选：下载/打开图片
          const url = URL.createObjectURL(blob);

          // iOS Safari 对 download 支持不稳定：通常更可靠的是打开新窗口让用户长按保存
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if (isIOS) {
            window.open(url, '_blank');
            shareBtn.innerHTML = `已打开图片，请长按保存<span class="en">Open & long-press to save</span>`;
            setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 2200);
            // 不要立刻 revoke（新窗口可能还在读）
            setTimeout(() => URL.revokeObjectURL(url), 10000);
            return;
          }

          // Android/桌面：用 a[download] 触发下载
          const a = document.createElement('a');
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          shareBtn.innerHTML = `已下载图片<span class="en">Downloaded</span>`;
          setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 1400);

        } catch (err) {
          console.error(err);
          shareBtn.innerHTML = `生成失败，请重试<span class="en">Failed</span>`;
          setTimeout(() => { shareBtn.innerHTML = oldHTML; }, 1600);
        } finally {
          document.body.classList.remove('screenshot-mode');
          shareBtn.style.pointerEvents = '';
        }
      });

      // init
      setHint('start');
      setProgress();
      updateCracks();
    })();
    
  </script>
</body>
</html>
